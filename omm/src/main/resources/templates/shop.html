<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>쇼핑몰</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/shop.css" rel="stylesheet">
</head>
<body>
<nav class="navbar">
    <div class="container">
        <!-- 브랜드명이나 로고 -->
        <a class="navbar-brand" href="/">Your Brand</a>
        <div class="navbar-links">
            <ul>
                <li sec:authorize="isAuthenticated()"><a href="/profile">마이페이지</a></li>
                <li sec:authorize="isAnonymous()"><a href="/login">로그인</a></li>
                <li sec:authorize="isAuthenticated()"><a href="/logout">로그아웃</a></li>
                <li sec:authorize="isAuthenticated()"><a href="/inquire">문의하기</a></li>
                <li><a href="/join">회원가입</a></li>
            </ul>
        </div>
    </div>
</nav>
<div class="container">
    <!-- 검색 및 카테고리 필터링 섹션 -->
    <div class="search-section">
        <form method="get" action="/shop">
            <input type="text" name="query" placeholder="검색어를 입력하세요" class="search-input" />
            <button type="submit" class="search-btn">검색</button>
        </form>
    </div>
    <!-- 배너 섹션: Bootstrap Carousel 사용 -->
    <div id="bannerCarousel" class="carousel slide banner-container" data-bs-ride="carousel">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img src="/img/배너1.png" class="d-block w-100 banner-img" alt="배너 이미지 1">
            </div>
            <div class="carousel-item">
                <img src="/img/배너2.png" class="d-block w-100 banner-img" alt="배너 이미지 2">
            </div>
            <div class="carousel-item">
                <img src="/img/배너3.png" class="d-block w-100 banner-img" alt="배너 이미지 3">
            </div>
        </div>

        <!-- 슬라이드 이전 버튼 -->
        <button class="carousel-control-prev" type="button" data-bs-target="#bannerCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">이전</span>
        </button>

        <!-- 슬라이드 다음 버튼 -->
        <button class="carousel-control-next" type="button" data-bs-target="#bannerCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">다음</span>
        </button>
    </div>

    <div class="main-content">
        <!-- 왼쪽 사이드바 -->
        <div class="sidebar">
            <form method="get" action="/shop">
                <div class="category-btn-group">
                    <button type="submit" name="searchCategory" value="" class="category-btn">전체</button>
                    <!-- 상위 카테고리 버튼들 -->
                    <div th:each="category : ${categories}">
                        <button type="button" class="category-btn"
                                th:id="'category-' + ${category.categoryId}"
                                th:onclick="'toggleSubcategories(' + ${category.categoryId} + ')'"
                                th:text="${category.categoryName}"></button>
                        <!-- 하위 카테고리 버튼 -->
                        <div th:if="${category.children != null}"
                             th:id="'subcategories-' + ${category.categoryId}"
                             class="subcategories">
                            <button type="submit" th:each="child : ${category.children}"
                                    name="searchCategory"
                                    th:value="${child.categoryId}"
                                    th:text="${child.categoryName}"
                                    class="subcategory-btn"></button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <!-- 오른쪽 상품 목록 섹션 -->
        <div class="products-section">
            <h2>상품 목록</h2>
            <div class="products-grid">
                <div class="product-card" th:each="food : ${foods}">
                    <div class="card">
                        <img th:src="${food.foodImg != null ? food.foodImg : '/images/default-image.jpg'}"
                             class="card-img-top" th:alt="${food.foodName}" />
                        <div class="card-body">
                            <h5 class="card-title" th:text="${food.foodName}"></h5>
                            <p class="card-price" th:text="${food.foodLprice} + '원'"></p>
                            <a th:href="@{/product/{foodProductId}(foodProductId=${food.foodProductId})}"
                               class="buy-btn" th:if="${food.foodProductId != null}">구매하기</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 페이징 네비게이션 -->
    <nav class="pagination-nav">
        <ul class="pagination">
            <li th:classappend="${currentPage == 1} ? 'disabled'">
                <a th:href="@{/shop(query=${query}, searchCategory=${searchCategory}, page=${currentPage - 1})}" aria-label="Previous">&laquo;</a>
            </li>
            <li th:each="i : ${#numbers.sequence(startPage, endPage)}" th:classappend="${i == currentPage} ? 'active'">
                <a th:href="@{/shop(query=${query}, searchCategory=${searchCategory}, page=${i})}" th:text="${i}"></a>
            </li>
            <li th:classappend="${endPage >= totalPages} ? 'disabled'">
                <a th:href="@{/shop(query=${query}, searchCategory=${searchCategory}, page=${endPage + 1})}" aria-label="Next">&raquo;</a>
            </li>
        </ul>
    </nav>
</div>

<footer>
    <p>&copy; Your Website 2023</p>
</footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- JavaScript to handle subcategories toggle and save category state -->
<script>
    function toggleSubcategories(categoryId) {
        const subcategoryContainer = document.getElementById(`subcategories-${categoryId}`);

        if (subcategoryContainer.style.height === '0px' || !subcategoryContainer.style.height) {
            // 높이가 0이거나 아직 설정되지 않았으면, 하위 카테고리 높이를 동적으로 계산
            const subcategoryHeight = subcategoryContainer.scrollHeight;
            subcategoryContainer.style.height = `${subcategoryHeight}px`; // 실제 높이로 전환
            subcategoryContainer.classList.add('show');
            localStorage.setItem('selectedCategoryId', categoryId);
        } else {
            // 높이를 다시 0으로 설정하여 숨기기
            subcategoryContainer.style.height = '0px';
            subcategoryContainer.classList.remove('show');
            localStorage.removeItem('selectedCategoryId');
        }
    }

    window.onload = function() {
        const selectedCategoryId = localStorage.getItem('selectedCategoryId');

        if (selectedCategoryId) {
            // 저장된 카테고리 ID의 하위 카테고리를 보여줌
            const subcategoryContainer = document.getElementById(`subcategories-${selectedCategoryId}`);
            if (subcategoryContainer) {
                subcategoryContainer.style.height = `${subcategoryContainer.scrollHeight}px`;
                subcategoryContainer.classList.add('show');
            }

            // 상위 카테고리 버튼의 스타일을 선택된 것처럼 표시
            const categoryButton = document.getElementById(`category-${selectedCategoryId}`);
            if (categoryButton) {
                categoryButton.classList.add('active');
            }
        }
    };

    // 배너 슬라이드 자동 전환 설정
    var myCarousel = document.querySelector('#bannerCarousel');
    var carousel = new bootstrap.Carousel(myCarousel, {
        interval: 3000, // 3초마다 슬라이드 전환
        wrap: true // 마지막 슬라이드 후 첫 슬라이드로 돌아감
    });
</script>

</body>
</html>

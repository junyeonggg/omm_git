<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상품 상세</title>
    <link rel="stylesheet" href="/css/product.css"> <!-- 외부 CSS 파일 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> <!-- FontAwesome for icons -->
</head>
<body>

<div class="container">
    <header class="header">
        <nav class="navbar">
            <div class="container">
                <a class="navbar-brand" href="/">Your Brand</a>
                <div class="navbar-content">
                    <ul class="navbar-nav">
                        <li class="nav-item"><a class="nav-link active" aria-current="page" th:href="@{/login}">로그인</a></li>
                        <li class="nav-item"><a class="nav-link" th:href="@{/join}">회원가입</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main class="main-content">
        <section class="product-details">
            <div class="product-image">
                <img th:if="${food != null && food.foodImg != null}" th:src="@{${food.foodImg}}" alt="상품 이미지"/>
                <img th:if="${food != null && food.foodImg == null}" th:src="@{/images/default-image.jpg}" alt="기본 이미지"/>
            </div>
            <div class="product-info">
                <h2 th:text="${food != null ? food.foodName : '상품 이름이 없습니다'}"></h2>
                <p th:text="${food != null ? food.foodLprice + '원' : '가격 정보가 없습니다'}" th:attr="data-price=${food != null ? food.foodLprice : 0}" id="price"></p>
                <p>무료 배송</p>
                <label for="quantity">수량:</label>
                <input type="number" id="quantity" name="quantity" min="1" value="1" class="form-control" onchange="updateTotalPrice()">
                <p id="totalPrice">총 가격: <span id="totalPriceValue" th:text="${food != null ? food.foodLprice : 0}">0</span>원</p>
                <div class="btn-container">
                    <a th:if="${food != null}" th:href="@{/cart}" class="btn btn-primary">장바구니</a>
                    <a th:if="${food != null}" th:href="@{/order}" class="btn btn-primary">바로구매</a>
                </div>
            </div>
        </section>

        <!-- 리뷰 섹션 추가 -->
        <section class="reviews-section mt-5">
            <h3>리뷰</h3>
            <div th:each="comment : ${comment_list}">
                <div class="card my-3" th:if="${comment.parent_comment_id == 0}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h5 class="card-title" th:text="${comment.user_id}"></h5>
                            <div class="rating">
                                <span th:each="i : ${#numbers.sequence(1, comment.comment_rating)}" class="fa fa-star checked" style="color: gold;"></span>
                                <span th:each="i : ${#numbers.sequence(comment.comment_rating + 1, 5)}" class="fa fa-star"></span>
                            </div>
                        </div>
                        <p class="card-text" th:text="${comment.comment_content}"></p>
                        <div class="c_comment" th:each="c_comment : ${comment_list}" th:if="${c_comment.parent_comment_id == comment.comment_id}">
                            <b th:text="'답글 작성자 :'+ ${c_comment.user_id}"></b><br>
                            <span th:text="${c_comment.comment_content}"></span><br>
                            <small th:text="${c_comment.comment_create_date}"></small>
                        </div>
                        <!-- 답글 폼 -->
                        <div class="mb-3">
                            <label for="replyContent" class="form-label">답글</label>
                            <textarea class="form-control" id="replyContent" name="replyContent" rows="2"></textarea>
                        </div>
                        <button type="button" onclick="insertReplyBtn(this,2)" th:data-user-id="${user_id}" th:data-target-id="${food.foodId}" th:data-user-nickname="${user_nickname}" th:data-parent-comment-id="${comment.comment_id}" th:data-type="replyContent" class="btn btn-secondary">답글 달기</button>
                    </div>
                </div>
            </div>

            <!-- 리뷰 작성 폼 -->
            <div th:if="${user_nickname != 'Null'}">
                <h4>리뷰 작성</h4>
                <div class="mb-3">
                    <span th:text="${user_nickname}">작성자 : </span>
                    <textarea class="form-control" id="comment_content" name="reviewContent" rows="3" required></textarea>
                </div>
                <div class="rate">
                    <input type="radio" id="star5" name="rating" value="5"><label for="star5" title="5 stars"></label>
                    <input type="radio" id="star4half" name="rating" value="4.5"><label for="star4half" class="half" title="4.5 stars"></label>
                    <input type="radio" id="star4" name="rating" value="4"><label for="star4" title="4 stars"></label>
                    <input type="radio" id="star3half" name="rating" value="3.5"><label for="star3half" class="half" title="3.5 stars"></label>
                    <input type="radio" id="star3" name="rating" value="3"><label for="star3" title="3 stars"></label>
                    <input type="radio" id="star2half" name="rating" value="2.5"><label for="star2half" class="half" title="2.5 stars"></label>
                    <input type="radio" id="star2" name="rating" value="2"><label for="star2" title="2 stars"></label>
                    <input type="radio" id="star1half" name="rating" value="1.5"><label for="star1half" class="half" title="1.5 stars"></label>
                    <input type="radio" id="star1" name="rating" value="1"><label for="star1" title="1 star"></label>
                    <input type="radio" id="starhalf" name="rating" value="0.5"><label for="starhalf" class="half" title="0.5 stars"></label>
                </div>
                <button type="button" onclick="insertReplyBtn(this,2)" th:data-user-id="${user_id}" th:data-target-id="${food.foodId}" th:data-user-nickname="${user_nickname}" data-parent-comment-id="0" th:data-type="comment_content" class="btn btn-primary mt-3">리뷰 작성</button>
            </div>
        </section>
    </main>

    <footer class="footer">
        <p class="text-center">&copy; Your Website 2023</p>
    </footer>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function updateTotalPrice() {
        const priceElement = document.getElementById('price');
        if (!priceElement) return;
        let price = priceElement.getAttribute('data-price');
        price = parseFloat(price.replace(/,/g, '').trim());
        const quantity = parseInt(document.getElementById('quantity').value);
        const totalPrice = quantity * price;
        document.getElementById('totalPriceValue').innerText = totalPrice.toLocaleString();
    }

    function insertReplyBtn(self,reference_type){
        const user_id = self.getAttribute("data-user-id");
        const type = self.getAttribute("data-type");
        const comment_content = document.querySelector(`#${type}`).value;
        const user_nickname = self.getAttribute("data-user-nickname");
        const comment_parent_id = self.getAttribute("data-parent-comment-id");
        const target_id = self.getAttribute("data-target-id");
        var rating = 0;
        const rating_radio_list = document.getElementsByName("rating");
        for (radio of rating_radio_list) {
            if (radio.checked && radio.value > rating) {
                rating = radio.value;
            }
        }
        $.ajax({
            type: "post",
            url : "/addreply",
            data : {
                'user_id': user_id,
                'comment_content': comment_content,
                'target_id': target_id,
                'parent_comment_id': comment_parent_id,
                'reference_type': reference_type,
                'comment_rating': rating
            },
            success : () => {
                window.alert("댓글을 등록하였습니다.");
                window.location.reload();
            },
            error : () => {
                window.alert("댓글 등록에 실패하였습니다.");
            }
        });
    }
</script>

</body>
</html>

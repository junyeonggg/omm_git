<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>상품 상세</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
.rate {
	display: inline-block;
	border: 0;
	margin-right: 15px;
}

.rate>input {
	display: none;
}

.rate>label {
	float: right;
	color: #ddd;
	font-size: 1.5rem;
}

.rate>label:before {
	display: inline-block;
	font-size: 1.5rem;
	padding: .3rem .2rem;
	margin: 0;
	cursor: pointer;
	font-family: FontAwesome;
	content: "\f005"; /* 별 모양 */
}

.rate .half:before {
	content: "\f089"; /* 반개 별 모양 */
	position: absolute;
	padding-right: 0;
}

.rate input:checked ~ label, .rate label:hover, .rate label:hover ~
	label {
	color: #f73c32 !important; /* 클릭되었거나 호버 상태의 별 색상 */
}

.rate input:checked+label:hover, .rate input input:checked ~ label:hover,
	.rate input:checked ~ label:hover ~ label, .rate label:hover ~ input:checked 
	~ label {
	color: #f73c32 !important; /* 호버 상태의 별 색상 */
}
</style>
</head>
<body>
	<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
		<div class="container">
			<!-- 브랜드명이나 로고 -->
			<a class="navbar-brand" href="/">Your Brand</a>
			<div class="collapse navbar-collapse" id="navbarSupportedContent">
				<!-- 중앙에 위치한 항목 (예: 네비게이션 링크) -->
				<ul class="navbar-nav me-auto">
					<!-- 여기에 다른 네비게이션 항목이 있을 수 있습니다 -->
				</ul>
				<!-- 오른쪽에 위치한 로그인/회원가입 버튼 -->
				<ul class="navbar-nav">
					<li class="nav-item"><a class="nav-link active"
						aria-current="page" th:href="@{/login}">로그인</a></li>
					<li class="nav-item"><a class="nav-link" th:href="@{/join}">회원가입</a></li>
				</ul>
			</div>
		</div>
	</nav>
	<div class="container my-5">
		<h1>상품 상세 정보</h1>

		<!-- 상품 상세 정보 -->
		<div class="row">
			<div class="col-md-6">
				<!-- 이미지가 있는 경우와 없는 경우를 나누어 설정 -->
				<img th:if="${food != null && food.foodImg != null}"
					th:src="@{${food.foodImg}}" class="img-fluid" alt="상품 이미지" /> <img
					th:if="${food != null && food.foodImg == null}"
					th:src="@{/images/default-image.jpg}" class="img-fluid"
					alt="기본 이미지" />
			</div>
			<div class="col-md-6">
				<!-- food 객체가 null이 아닌지 확인 -->
				<h2 th:text="${food != null ? food.foodName : '상품 이름이 없습니다'}"></h2>
				<!-- 가격을 데이터 속성에 저장하여 JavaScript에서 사용할 수 있게 설정 -->
				<p th:text="${food != null ? food.foodLprice + '원' : '가격 정보가 없습니다'}"
					th:attr="data-price=${food != null ? food.foodLprice : 0}"
					id="price"></p>
				<p>무료 배송</p>
				<!-- 개수 선택 버튼과 총 가격 표시 -->
				<div>
					<label for="quantity">수량:</label> <input type="number"
						id="quantity" name="quantity" min="1" value="1"
						class="form-control" style="width: 100px; display: inline-block;"
						onchange="updateTotalPrice()">
					<p id="totalPrice">
						총 가격: <span id="totalPriceValue"
							th:text="${food != null ? food.foodLprice : 0}">0</span>원
					</p>
				</div>
				<!-- food 객체가 null이 아닌 경우에만 구매하기 버튼 표시 -->
				<a th:if="${food != null}" th:href="@{/cart}"
					class="btn btn-primary">장바구니</a> <a th:if="${food != null}"
					th:href="@{#}"
					th:onclick="insertCart([[${user_id}]],[[${food.foodId}]])"
					class="btn btn-primary">장바구니 담기</a> <a th:if="${food != null}"
					th:href="@{/order}" class="btn btn-primary">바로구매</a>
			</div>
		</div>
		<!-- 리뷰 섹션 -->
		<div class="mt-5">
			<h3>리뷰</h3>
			<!-- 리뷰 리스트 -->
			<div th:each="comment : ${comment_list}">
				<div class="card my-3" th:if="${comment.parent_comment_id == 0}">
					<div class="card-body">
						<!-- 리뷰 작성자와 별점 표시 -->
						<div>
							<div class="d-flex justify-content-between">
								<h5 class="card-title" th:text="${comment.user_id}"></h5>
								<div class="rating">
									<span
										th:each="i : ${#numbers.sequence(1, comment.comment_rating)}"
										class="fa fa-star checked" style="color: gold;"></span> <span
										th:each="i : ${#numbers.sequence(comment.comment_rating + 1, 5)}"
										class="fa fa-star"></span>
								</div>
							</div>
							<p class="card-text" th:text="${comment.comment_content}"></p>
						</div>
						<!-- 답글 출력 -->
						<br>
						<div class="c_comment" th:each="c_comment : ${comment_list}"
							th:if="${c_comment.parent_comment_id == comment.comment_id}">
							<b th:text="'답글 작성자 :'+ ${c_comment.user_id}"></b><br> <span
								th:text="${c_comment.comment_content}"></span><br> <small
								th:text="${c_comment.comment_create_date}"></small>
						</div>


						<!-- 답글 폼 -->
						<div class="mb-3">
							<label for="replyContent" class="form-label">답글</label>
							<textarea class="form-control" id="replyContent"
								name="replyContent" rows="2"></textarea>
						</div>
						<button type="button" onclick="insertReplyBtn(this,2)"
							th:data-user-id="${user_id}" th:data-target-id="${food.foodId}"
							th:data-user-nickname="${user_nickname}"
							th:data-parent-comment-id="${comment.comment_id}"
							th:data-type="replyContent" class="btn btn-secondary">답글
							달기</button>
					</div>
				</div>
			</div>

			<!-- 리뷰 작성 폼 -->
			<div th:if="${user_nickname != 'Null'}">
				<h4>리뷰 작성</h4>
				<div class="mb-3">
					<span th:text="${user_nickname}">작성자 : </span>
					<textarea class="form-control" id="comment_content"
						name="reviewContent" rows="3" required></textarea>
				</div>
				<!-- 별점 -->
				<div class="rate">
					<input type="radio" id="star5" name="rating" value="5"> <label
						for="star5" title="5 stars"> </label> <input type="radio"
						id="star4half" name="rating" value="4.5"> <label
						for="star4half" class="half" title="4.5 stars"></label> <input
						type="radio" id="star4" name="rating" value="4"> <label
						for="star4" title="4 stars"></label> <input type="radio"
						id="star3half" name="rating" value="3.5"> <label
						for="star3half" class="half" title="3.5 stars"></label> <input
						type="radio" id="star3" name="rating" value="3"> <label
						for="star3" title="3 stars"></label> <input type="radio"
						id="star2half" name="rating" value="2.5"> <label
						for="star2half" class="half" title="2.5 stars"></label> <input
						type="radio" id="star2" name="rating" value="2"> <label
						for="star2" title="2 stars"></label> <input type="radio"
						id="star1half" name="rating" value="1.5"> <label
						for="star1half" class="half" title="1.5 stars"></label> <input
						type="radio" id="star1" name="rating" value="1"> <label
						for="star1" title="1 star"></label> <input type="radio"
						id="starhalf" name="rating" value="0.5"> <label
						for="starhalf" class="half" title="0.5 stars"></label>
				</div>
				<button type="button" onclick="insertReplyBtn(this,2)"
					th:data-user-id="${user_id}" th:data-target-id="${food.foodId}"
					th:data-user-nickname="${user_nickname}" data-parent-comment-id="0"
					th:data-type="comment_content" class="btn btn-primary mt-3">리뷰
					작성</button>
			</div>
		</div>
	</div>
	<footer class="py-5 bg-dark">
		<div class="container">
			<p class="m-0 text-center text-white">&copy; Your Website 2023</p>
		</div>
	</footer>
	<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
	<script>
    function updateTotalPrice() {
        // price 요소와 그 데이터 속성을 가져오기
        const priceElement = document.getElementById('price');
        if (!priceElement) return; // price 요소가 없으면 함수 종료

        // 데이터 속성에서 가격을 가져옴 (문자열 -> 숫자로 변환)
        let price = priceElement.getAttribute('data-price');
        price = parseFloat(price.replace(/,/g, '').trim()); // 쉼표 제거 후 숫자로 변환

        // 수량 가져오기
        const quantity = parseInt(document.getElementById('quantity').value);

        // 총 가격 계산
        const totalPrice = quantity * price;

        // 총 가격 표시 업데이트
        document.getElementById('totalPriceValue').innerText = totalPrice.toLocaleString();
    }
    function insertReplyBtn(self,reference_type){
	const user_id = self.getAttribute("data-user-id")

	// 댓글인지 대댓글인지 판별 (댓글이면 댓글textarea, 대댓글이면 대댓글textarea의 값을 가져옴)
	const type = self.getAttribute("data-type")
	const comment_content = document.querySelector(`#${type}`).value;
	const user_nickname = self.getAttribute("data-user-nickname");
	const comment_parent_id = self.getAttribute("data-parent-comment-id")
	const target_id = self.getAttribute("data-target-id");
    console.log(target_id)
	var rating = 0;
	const rating_radio_list = document.getElementsByName("rating")
	for(radio of rating_radio_list){
		if(radio.checked & radio.value > rating){
			rating = radio.value
		}
	}
	$.ajax({
		type:"post",
		url : "/addreply",
		data : {'user_id' : user_id,
				'comment_content':comment_content,
				'target_id':target_id,
				'parent_comment_id' : comment_parent_id,
				'reference_type':reference_type,
				'comment_rating':rating
				},
		success : ()=>{
			window.alert("댓글을 등록하였습니다.");
		 	window.location.reload()
		 	},
		error : ()=>{
			window.alert("댓글 등록에 실패하였습니다.")}

	})
}
    
function insertCart(user_id,food_id){
	const quantity = document.querySelector("#quantity").value;
	$.ajax({
		type:"post",
		url : "/cart/insert",
		data : {user_id:user_id,food_id:food_id,food_quantity:quantity},
		success: data => {
			if(data){
				window.alert("이미 담긴 상품입니다.")
			}else{
				window.alert("장바구니에 담았습니다.")
			}
		}
	})
	
}
</script>
</body>
</html>
